2025-12-17 12:48:20,206 [INFO] root: ðŸš€ Bot starting...
2025-12-17 12:48:20,248 [INFO] aiogram.dispatcher: Start polling
2025-12-17 12:48:24,624 [WARNING] aiogram.dispatcher: Received SIGINT signal
2025-12-17 12:48:24,626 [INFO] aiogram.dispatcher: Polling stopped
2025-12-17 12:51:50,188 [INFO] root: ðŸš€ Bot starting...
2025-12-17 12:51:50,228 [INFO] aiogram.dispatcher: Start polling
2025-12-17 12:51:50,642 [INFO] aiogram.dispatcher: Run polling for bot @BalanceTeBot id=8531768574 - 'BalanceBot'
2025-12-17 12:52:02,490 [INFO] sqlalchemy.engine.Engine: select pg_catalog.version()
2025-12-17 12:52:02,490 [INFO] sqlalchemy.engine.Engine: [raw sql] ()
2025-12-17 12:52:02,494 [INFO] sqlalchemy.engine.Engine: select current_schema()
2025-12-17 12:52:02,494 [INFO] sqlalchemy.engine.Engine: [raw sql] ()
2025-12-17 12:52:02,497 [INFO] sqlalchemy.engine.Engine: show standard_conforming_strings
2025-12-17 12:52:02,497 [INFO] sqlalchemy.engine.Engine: [raw sql] ()
2025-12-17 12:52:02,499 [INFO] sqlalchemy.engine.Engine: BEGIN (implicit)
2025-12-17 12:52:02,502 [INFO] sqlalchemy.engine.Engine: SELECT balance_state.chat_id, balance_state.user_id, balance_state.balance, balance_state.checks_count, balance_state.created_at, balance_state.updated_at 
FROM balance_state 
WHERE balance_state.chat_id = $1::BIGINT AND balance_state.user_id = $2::BIGINT
2025-12-17 12:52:02,502 [INFO] sqlalchemy.engine.Engine: [generated in 0.00017s] (99169335, 99169335)
2025-12-17 12:52:02,506 [INFO] sqlalchemy.engine.Engine: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at
2025-12-17 12:52:02,507 [INFO] sqlalchemy.engine.Engine: [generated in 0.00015s] (99169335, 99169335, 0, 0)
2025-12-17 12:52:02,508 [INFO] logger.logs_setting: RESET | chat_id=99169335 | user_id=99169335 | balance_before=0 | checks_before=0
2025-12-17 12:52:02,934 [INFO] sqlalchemy.engine.Engine: COMMIT
2025-12-17 12:52:02,939 [INFO] logger.logs_setting: RESET_DONE | chat_id=99169335 | user_id=99169335 | balance_after=0 | checks_after=0
2025-12-17 12:52:02,940 [INFO] aiogram.event: Update id=282851705 is handled. Duration 487 ms by bot id=8531768574
2025-12-17 12:52:07,574 [INFO] sqlalchemy.engine.Engine: BEGIN (implicit)
2025-12-17 12:52:07,577 [INFO] sqlalchemy.engine.Engine: SELECT balance_state.chat_id, balance_state.user_id, balance_state.balance, balance_state.checks_count, balance_state.created_at, balance_state.updated_at 
FROM balance_state 
WHERE balance_state.chat_id = $1::BIGINT AND balance_state.user_id = $2::BIGINT
2025-12-17 12:52:07,577 [INFO] sqlalchemy.engine.Engine: [cached since 5.076s ago] (99169335, 99169335)
2025-12-17 12:52:07,580 [INFO] sqlalchemy.engine.Engine: INSERT INTO balance_operation (chat_id, user_id, delta) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT) RETURNING balance_operation.id, balance_operation.created_at
2025-12-17 12:52:07,583 [INFO] sqlalchemy.engine.Engine: [generated in 0.00300s] (99169335, 99169335, 200000)
2025-12-17 12:52:07,588 [INFO] sqlalchemy.engine.Engine: UPDATE balance_state SET balance=$1::BIGINT, checks_count=$2::INTEGER, updated_at=now() WHERE balance_state.chat_id = $3::BIGINT AND balance_state.user_id = $4::BIGINT
2025-12-17 12:52:07,588 [INFO] sqlalchemy.engine.Engine: [generated in 0.00016s] (200000, 1, 99169335, 99169335)
2025-12-17 12:52:07,591 [INFO] sqlalchemy.engine.Engine: COMMIT
2025-12-17 12:52:07,592 [INFO] logger.logs_setting: BALANCE_UPDATE | chat_id=99169335 | user_id=99169335 | delta=200000 | balance: 0 -> 200000 | checks: 0 -> 1
2025-12-17 12:52:07,592 [INFO] logger.logs_setting: APPLY_DELTA | chat_id=99169335 | user_id=99169335 | delta=200000 | balance: 0 -> 200000 | checks: 0 -> 1
2025-12-17 12:52:07,738 [INFO] aiogram.event: Update id=282851706 is handled. Duration 169 ms by bot id=8531768574
2025-12-17 12:52:09,878 [INFO] sqlalchemy.engine.Engine: BEGIN (implicit)
2025-12-17 12:52:09,878 [INFO] sqlalchemy.engine.Engine: SELECT balance_state.chat_id, balance_state.user_id, balance_state.balance, balance_state.checks_count, balance_state.created_at, balance_state.updated_at 
FROM balance_state 
WHERE balance_state.chat_id = $1::BIGINT AND balance_state.user_id = $2::BIGINT
2025-12-17 12:52:09,878 [INFO] sqlalchemy.engine.Engine: [cached since 7.377s ago] (99169335, 99169335)
2025-12-17 12:52:09,881 [INFO] sqlalchemy.engine.Engine: INSERT INTO balance_operation (chat_id, user_id, delta) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT) RETURNING balance_operation.id, balance_operation.created_at
2025-12-17 12:52:09,881 [INFO] sqlalchemy.engine.Engine: [cached since 2.301s ago] (99169335, 99169335, 3000000)
2025-12-17 12:52:09,882 [INFO] sqlalchemy.engine.Engine: UPDATE balance_state SET balance=$1::BIGINT, checks_count=$2::INTEGER, updated_at=now() WHERE balance_state.chat_id = $3::BIGINT AND balance_state.user_id = $4::BIGINT
2025-12-17 12:52:09,882 [INFO] sqlalchemy.engine.Engine: [cached since 2.295s ago] (3200000, 2, 99169335, 99169335)
2025-12-17 12:52:09,884 [INFO] sqlalchemy.engine.Engine: COMMIT
2025-12-17 12:52:09,886 [INFO] logger.logs_setting: BALANCE_UPDATE | chat_id=99169335 | user_id=99169335 | delta=3000000 | balance: 200000 -> 3200000 | checks: 1 -> 2
2025-12-17 12:52:09,886 [INFO] logger.logs_setting: APPLY_DELTA | chat_id=99169335 | user_id=99169335 | delta=3000000 | balance: 200000 -> 3200000 | checks: 1 -> 2
2025-12-17 12:52:10,055 [INFO] aiogram.event: Update id=282851707 is handled. Duration 181 ms by bot id=8531768574
2025-12-17 12:53:27,382 [INFO] aiogram.event: Update id=282851708 is not handled. Duration 1 ms by bot id=8531768574
2025-12-17 12:53:52,996 [INFO] aiogram.event: Update id=282851709 is handled. Duration 255 ms by bot id=8531768574
2025-12-17 12:59:31,922 [INFO] aiogram.event: Update id=282851710 is not handled. Duration 2 ms by bot id=8531768574
2025-12-17 12:59:43,782 [INFO] aiogram.event: Update id=282851711 is handled. Duration 230 ms by bot id=8531768574
2025-12-17 12:59:47,263 [INFO] sqlalchemy.engine.Engine: BEGIN (implicit)
2025-12-17 12:59:47,264 [INFO] sqlalchemy.engine.Engine: SELECT balance_state.chat_id, balance_state.user_id, balance_state.balance, balance_state.checks_count, balance_state.created_at, balance_state.updated_at 
FROM balance_state 
WHERE balance_state.chat_id = $1::BIGINT AND balance_state.user_id = $2::BIGINT
2025-12-17 12:59:47,264 [INFO] sqlalchemy.engine.Engine: [cached since 464.8s ago] (-1001125536529, 99169335)
2025-12-17 12:59:47,272 [INFO] sqlalchemy.engine.Engine: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at
2025-12-17 12:59:47,272 [INFO] sqlalchemy.engine.Engine: [cached since 464.8s ago] (-1001125536529, 99169335, 0, 0)
2025-12-17 12:59:47,275 [INFO] sqlalchemy.engine.Engine: ROLLBACK
2025-12-17 12:59:47,277 [INFO] aiogram.event: Update id=282851712 is not handled. Duration 25 ms by bot id=8531768574
2025-12-17 12:59:47,277 [ERROR] aiogram.event: Cause exception while process update id=282851712 by bot id=8531768574
IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.
[SQL: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at]
[parameters: (-1001125536529, 99169335, 0, 0)]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/prepared_stmt.py", line 177, in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/prepared_stmt.py", line 268, in __bind_execute
    data, status, _ = await self.__do_execute(
                      ^^^^^^^^^^^^^^^^^^^^^^^^
        lambda protocol: protocol.bind_execute(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            self._state, args, '', limit, True, timeout))
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/prepared_stmt.py", line 257, in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 205, in bind_execute
asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self._prepare_and_execute(operation, parameters)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 320, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 164, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<7 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/middlewares/error.py", line 27, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 58, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/fsm/middleware.py", line 43, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/telegram.py", line 126, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 283, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 161, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 153, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<4 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 189, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 161, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 153, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<4 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 181, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/telegram.py", line 126, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/middlewares/admin_only.py", line 23, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/bot/handlers/balance.py", line 64, in handle_amount
    state = await repo.get_or_create(
            ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/repositories/balance.py", line 33, in get_or_create
    await session.flush()
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py", line 787, in flush
    await greenlet_spawn(self.sync_session.flush, objects=objects)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper,
        ^^^^^^^^^^^^
    ...<3 lines>...
        insert,
        ^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
        statement,
        params,
        execution_options=execution_options,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py", line 527, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 2363, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self._prepare_and_execute(operation, parameters)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.
[SQL: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at]
[parameters: (-1001125536529, 99169335, 0, 0)]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-17 13:00:07,929 [INFO] aiogram.event: Update id=282851713 is not handled. Duration 1 ms by bot id=8531768574
2025-12-17 13:00:15,881 [INFO] aiogram.event: Update id=282851714 is not handled. Duration 4 ms by bot id=8531768574
2025-12-17 13:00:47,204 [INFO] aiogram.event: Update id=282851715 is handled. Duration 150 ms by bot id=8531768574
2025-12-17 13:00:54,292 [INFO] aiogram.event: Update id=282851716 is not handled. Duration 1 ms by bot id=8531768574
2025-12-17 13:01:03,928 [INFO] sqlalchemy.engine.Engine: BEGIN (implicit)
2025-12-17 13:01:03,929 [INFO] sqlalchemy.engine.Engine: SELECT balance_state.chat_id, balance_state.user_id, balance_state.balance, balance_state.checks_count, balance_state.created_at, balance_state.updated_at 
FROM balance_state 
WHERE balance_state.chat_id = $1::BIGINT AND balance_state.user_id = $2::BIGINT
2025-12-17 13:01:03,929 [INFO] sqlalchemy.engine.Engine: [cached since 541.4s ago] (-536501530, 99169335)
2025-12-17 13:01:03,933 [INFO] sqlalchemy.engine.Engine: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at
2025-12-17 13:01:03,933 [INFO] sqlalchemy.engine.Engine: [cached since 541.4s ago] (-536501530, 99169335, 0, 0)
2025-12-17 13:01:03,936 [INFO] sqlalchemy.engine.Engine: ROLLBACK
2025-12-17 13:01:03,940 [INFO] aiogram.event: Update id=282851717 is not handled. Duration 18 ms by bot id=8531768574
2025-12-17 13:01:03,940 [ERROR] aiogram.event: Cause exception while process update id=282851717 by bot id=8531768574
IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.
[SQL: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at]
[parameters: (-536501530, 99169335, 0, 0)]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/prepared_stmt.py", line 177, in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/prepared_stmt.py", line 268, in __bind_execute
    data, status, _ = await self.__do_execute(
                      ^^^^^^^^^^^^^^^^^^^^^^^^
        lambda protocol: protocol.bind_execute(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            self._state, args, '', limit, True, timeout))
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/prepared_stmt.py", line 257, in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 205, in bind_execute
asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self._prepare_and_execute(operation, parameters)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 320, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 164, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<7 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/middlewares/error.py", line 27, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 58, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/fsm/middleware.py", line 43, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/telegram.py", line 126, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 283, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 161, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 153, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<4 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 189, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 161, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 153, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<4 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 181, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/telegram.py", line 126, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/middlewares/admin_only.py", line 23, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/bot/handlers/balance.py", line 64, in handle_amount
    state = await repo.get_or_create(
            ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/repositories/balance.py", line 33, in get_or_create
    await session.flush()
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py", line 787, in flush
    await greenlet_spawn(self.sync_session.flush, objects=objects)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper,
        ^^^^^^^^^^^^
    ...<3 lines>...
        insert,
        ^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
        statement,
        params,
        execution_options=execution_options,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py", line 527, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 2363, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self._prepare_and_execute(operation, parameters)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.
[SQL: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at]
[parameters: (-536501530, 99169335, 0, 0)]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-17 13:01:39,816 [INFO] sqlalchemy.engine.Engine: BEGIN (implicit)
2025-12-17 13:01:39,817 [INFO] sqlalchemy.engine.Engine: SELECT balance_state.chat_id, balance_state.user_id, balance_state.balance, balance_state.checks_count, balance_state.created_at, balance_state.updated_at 
FROM balance_state 
WHERE balance_state.chat_id = $1::BIGINT AND balance_state.user_id = $2::BIGINT
2025-12-17 13:01:39,817 [INFO] sqlalchemy.engine.Engine: [cached since 577.3s ago] (-536501530, 99169335)
2025-12-17 13:01:39,822 [INFO] sqlalchemy.engine.Engine: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at
2025-12-17 13:01:39,823 [INFO] sqlalchemy.engine.Engine: [cached since 577.3s ago] (-536501530, 99169335, 0, 0)
2025-12-17 13:01:39,825 [INFO] sqlalchemy.engine.Engine: ROLLBACK
2025-12-17 13:01:39,826 [INFO] aiogram.event: Update id=282851718 is not handled. Duration 20 ms by bot id=8531768574
2025-12-17 13:01:39,826 [ERROR] aiogram.event: Cause exception while process update id=282851718 by bot id=8531768574
IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.
[SQL: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at]
[parameters: (-536501530, 99169335, 0, 0)]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/prepared_stmt.py", line 177, in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/prepared_stmt.py", line 268, in __bind_execute
    data, status, _ = await self.__do_execute(
                      ^^^^^^^^^^^^^^^^^^^^^^^^
        lambda protocol: protocol.bind_execute(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            self._state, args, '', limit, True, timeout))
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/prepared_stmt.py", line 257, in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 205, in bind_execute
asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self._prepare_and_execute(operation, parameters)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 320, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 164, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<7 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/middlewares/error.py", line 27, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 58, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/fsm/middleware.py", line 43, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/telegram.py", line 126, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 283, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 161, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 153, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<4 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 189, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 161, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 153, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<4 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 181, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/telegram.py", line 126, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/middlewares/admin_only.py", line 23, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/bot/handlers/balance.py", line 64, in handle_amount
    state = await repo.get_or_create(
            ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/repositories/balance.py", line 33, in get_or_create
    await session.flush()
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py", line 787, in flush
    await greenlet_spawn(self.sync_session.flush, objects=objects)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper,
        ^^^^^^^^^^^^
    ...<3 lines>...
        insert,
        ^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
        statement,
        params,
        execution_options=execution_options,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py", line 527, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 2363, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self._prepare_and_execute(operation, parameters)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.
[SQL: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at]
[parameters: (-536501530, 99169335, 0, 0)]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-17 13:01:42,396 [WARNING] aiogram.dispatcher: Received SIGINT signal
2025-12-17 13:01:42,397 [INFO] aiogram.dispatcher: Polling stopped for bot @BalanceTeBot id=8531768574 - 'BalanceBot'
2025-12-17 13:01:42,398 [INFO] aiogram.dispatcher: Polling stopped
2025-12-17 13:01:45,281 [INFO] root: ðŸš€ Bot starting...
2025-12-17 13:01:45,319 [INFO] aiogram.dispatcher: Start polling
2025-12-17 13:01:45,709 [INFO] aiogram.dispatcher: Run polling for bot @BalanceTeBot id=8531768574 - 'BalanceBot'
2025-12-17 13:01:48,469 [INFO] sqlalchemy.engine.Engine: select pg_catalog.version()
2025-12-17 13:01:48,469 [INFO] sqlalchemy.engine.Engine: [raw sql] ()
2025-12-17 13:01:48,473 [INFO] sqlalchemy.engine.Engine: select current_schema()
2025-12-17 13:01:48,473 [INFO] sqlalchemy.engine.Engine: [raw sql] ()
2025-12-17 13:01:48,476 [INFO] sqlalchemy.engine.Engine: show standard_conforming_strings
2025-12-17 13:01:48,476 [INFO] sqlalchemy.engine.Engine: [raw sql] ()
2025-12-17 13:01:48,478 [INFO] sqlalchemy.engine.Engine: BEGIN (implicit)
2025-12-17 13:01:48,480 [INFO] sqlalchemy.engine.Engine: SELECT balance_state.chat_id, balance_state.user_id, balance_state.balance, balance_state.checks_count, balance_state.created_at, balance_state.updated_at 
FROM balance_state 
WHERE balance_state.chat_id = $1::BIGINT AND balance_state.user_id = $2::BIGINT
2025-12-17 13:01:48,480 [INFO] sqlalchemy.engine.Engine: [generated in 0.00014s] (-536501530, 99169335)
2025-12-17 13:01:48,486 [INFO] sqlalchemy.engine.Engine: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at
2025-12-17 13:01:48,486 [INFO] sqlalchemy.engine.Engine: [generated in 0.00016s] (-536501530, 99169335, 0, 0)
2025-12-17 13:01:48,488 [INFO] sqlalchemy.engine.Engine: ROLLBACK
2025-12-17 13:01:48,489 [INFO] aiogram.event: Update id=282851719 is not handled. Duration 52 ms by bot id=8531768574
2025-12-17 13:01:48,489 [ERROR] aiogram.event: Cause exception while process update id=282851719 by bot id=8531768574
IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.
[SQL: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at]
[parameters: (-536501530, 99169335, 0, 0)]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/prepared_stmt.py", line 177, in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/prepared_stmt.py", line 268, in __bind_execute
    data, status, _ = await self.__do_execute(
                      ^^^^^^^^^^^^^^^^^^^^^^^^
        lambda protocol: protocol.bind_execute(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            self._state, args, '', limit, True, timeout))
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/prepared_stmt.py", line 257, in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 205, in bind_execute
asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self._prepare_and_execute(operation, parameters)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 320, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 164, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<7 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/middlewares/error.py", line 27, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 58, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/fsm/middleware.py", line 43, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/telegram.py", line 126, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 283, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 161, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 153, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<4 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 189, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 161, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 153, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<4 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 181, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/telegram.py", line 126, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/middlewares/admin_only.py", line 23, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/bot/handlers/balance.py", line 64, in handle_amount
    state = await repo.get_or_create(
            ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/repositories/balance.py", line 33, in get_or_create
    await session.flush()
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py", line 787, in flush
    await greenlet_spawn(self.sync_session.flush, objects=objects)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper,
        ^^^^^^^^^^^^
    ...<3 lines>...
        insert,
        ^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
        statement,
        params,
        execution_options=execution_options,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py", line 527, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 2363, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self._prepare_and_execute(operation, parameters)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.
[SQL: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at]
[parameters: (-536501530, 99169335, 0, 0)]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-17 13:06:42,438 [WARNING] aiogram.dispatcher: Received SIGINT signal
2025-12-17 13:06:42,440 [INFO] aiogram.dispatcher: Polling stopped for bot @BalanceTeBot id=8531768574 - 'BalanceBot'
2025-12-17 13:06:42,440 [INFO] aiogram.dispatcher: Polling stopped
2025-12-17 13:11:58,164 [INFO] root: ðŸš€ Bot starting...
2025-12-17 13:11:58,204 [INFO] aiogram.dispatcher: Start polling
2025-12-17 13:11:58,592 [INFO] aiogram.dispatcher: Run polling for bot @BalanceTeBot id=8531768574 - 'BalanceBot'
2025-12-17 13:12:09,953 [INFO] sqlalchemy.engine.Engine: select pg_catalog.version()
2025-12-17 13:12:09,953 [INFO] sqlalchemy.engine.Engine: [raw sql] ()
2025-12-17 13:12:09,958 [INFO] sqlalchemy.engine.Engine: select current_schema()
2025-12-17 13:12:09,958 [INFO] sqlalchemy.engine.Engine: [raw sql] ()
2025-12-17 13:12:09,961 [INFO] sqlalchemy.engine.Engine: show standard_conforming_strings
2025-12-17 13:12:09,961 [INFO] sqlalchemy.engine.Engine: [raw sql] ()
2025-12-17 13:12:09,964 [INFO] sqlalchemy.engine.Engine: BEGIN (implicit)
2025-12-17 13:12:09,969 [INFO] sqlalchemy.engine.Engine: SELECT balance_state.chat_id, balance_state.user_id, balance_state.balance, balance_state.checks_count, balance_state.created_at, balance_state.updated_at 
FROM balance_state 
WHERE balance_state.chat_id = $1::BIGINT AND balance_state.user_id = $2::BIGINT
2025-12-17 13:12:09,969 [INFO] sqlalchemy.engine.Engine: [generated in 0.00016s] (-536501530, 99169335)
2025-12-17 13:12:09,975 [INFO] sqlalchemy.engine.Engine: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at
2025-12-17 13:12:09,975 [INFO] sqlalchemy.engine.Engine: [generated in 0.00029s] (-536501530, 99169335, 0, 0)
2025-12-17 13:12:09,978 [INFO] sqlalchemy.engine.Engine: ROLLBACK
2025-12-17 13:12:09,979 [INFO] aiogram.event: Update id=282851720 is not handled. Duration 67 ms by bot id=8531768574
2025-12-17 13:12:09,979 [ERROR] aiogram.event: Cause exception while process update id=282851720 by bot id=8531768574
IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.
[SQL: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at]
[parameters: (-536501530, 99169335, 0, 0)]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/prepared_stmt.py", line 177, in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/prepared_stmt.py", line 268, in __bind_execute
    data, status, _ = await self.__do_execute(
                      ^^^^^^^^^^^^^^^^^^^^^^^^
        lambda protocol: protocol.bind_execute(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            self._state, args, '', limit, True, timeout))
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/prepared_stmt.py", line 257, in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 205, in bind_execute
asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self._prepare_and_execute(operation, parameters)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 320, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 164, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<7 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/middlewares/error.py", line 27, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 58, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/fsm/middleware.py", line 43, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/telegram.py", line 126, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 283, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 161, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 153, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<4 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 189, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 161, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 153, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<4 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 181, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/telegram.py", line 126, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/middlewares/admin_only.py", line 23, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/bot/handlers/balance.py", line 72, in handle_amount
    state = await repo.get_or_create(
            ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/repositories/balance.py", line 33, in get_or_create
    await session.flush()
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py", line 787, in flush
    await greenlet_spawn(self.sync_session.flush, objects=objects)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper,
        ^^^^^^^^^^^^
    ...<3 lines>...
        insert,
        ^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
        statement,
        params,
        execution_options=execution_options,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py", line 527, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 2363, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self._prepare_and_execute(operation, parameters)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.
[SQL: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at]
[parameters: (-536501530, 99169335, 0, 0)]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-17 13:14:13,715 [WARNING] aiogram.dispatcher: Received SIGINT signal
2025-12-17 13:14:13,717 [INFO] aiogram.dispatcher: Polling stopped for bot @BalanceTeBot id=8531768574 - 'BalanceBot'
2025-12-17 13:14:13,718 [INFO] aiogram.dispatcher: Polling stopped
2025-12-17 13:14:16,696 [INFO] root: ðŸš€ Bot starting...
2025-12-17 13:14:16,731 [INFO] aiogram.dispatcher: Start polling
2025-12-17 13:14:17,131 [INFO] aiogram.dispatcher: Run polling for bot @BalanceTeBot id=8531768574 - 'BalanceBot'
2025-12-17 13:14:20,970 [INFO] sqlalchemy.engine.Engine: select pg_catalog.version()
2025-12-17 13:14:20,970 [INFO] sqlalchemy.engine.Engine: [raw sql] ()
2025-12-17 13:14:20,973 [INFO] sqlalchemy.engine.Engine: select current_schema()
2025-12-17 13:14:20,973 [INFO] sqlalchemy.engine.Engine: [raw sql] ()
2025-12-17 13:14:20,974 [INFO] sqlalchemy.engine.Engine: show standard_conforming_strings
2025-12-17 13:14:20,974 [INFO] sqlalchemy.engine.Engine: [raw sql] ()
2025-12-17 13:14:20,976 [INFO] sqlalchemy.engine.Engine: BEGIN (implicit)
2025-12-17 13:14:20,977 [INFO] sqlalchemy.engine.Engine: SELECT balance_state.chat_id, balance_state.user_id, balance_state.balance, balance_state.checks_count, balance_state.created_at, balance_state.updated_at 
FROM balance_state 
WHERE balance_state.chat_id = $1::BIGINT AND balance_state.user_id = $2::BIGINT
2025-12-17 13:14:20,977 [INFO] sqlalchemy.engine.Engine: [generated in 0.00007s] (-536501530, 99169335)
2025-12-17 13:14:20,980 [INFO] sqlalchemy.engine.Engine: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at
2025-12-17 13:14:20,980 [INFO] sqlalchemy.engine.Engine: [generated in 0.00010s] (-536501530, 99169335, 0, 0)
2025-12-17 13:14:20,982 [INFO] sqlalchemy.engine.Engine: ROLLBACK
2025-12-17 13:14:20,983 [INFO] aiogram.event: Update id=282851721 is not handled. Duration 36 ms by bot id=8531768574
2025-12-17 13:14:20,983 [ERROR] aiogram.event: Cause exception while process update id=282851721 by bot id=8531768574
IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.
[SQL: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at]
[parameters: (-536501530, 99169335, 0, 0)]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/prepared_stmt.py", line 177, in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/prepared_stmt.py", line 268, in __bind_execute
    data, status, _ = await self.__do_execute(
                      ^^^^^^^^^^^^^^^^^^^^^^^^
        lambda protocol: protocol.bind_execute(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            self._state, args, '', limit, True, timeout))
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/prepared_stmt.py", line 257, in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 205, in bind_execute
asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self._prepare_and_execute(operation, parameters)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.IntegrityError: <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 320, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 164, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<7 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/middlewares/error.py", line 27, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 58, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/fsm/middleware.py", line 43, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/telegram.py", line 126, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 283, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 161, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 153, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<4 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 189, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 161, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 153, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<4 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 181, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/telegram.py", line 126, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/middlewares/admin_only.py", line 23, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/bot/handlers/balance.py", line 65, in handle_amount
    state = await repo.get_or_create(
            ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/repositories/balance.py", line 33, in get_or_create
    await session.flush()
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py", line 787, in flush
    await greenlet_spawn(self.sync_session.flush, objects=objects)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper,
        ^^^^^^^^^^^^
    ...<3 lines>...
        insert,
        ^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
        statement,
        params,
        execution_options=execution_options,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py", line 527, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 2363, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self._prepare_and_execute(operation, parameters)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.IntegrityError: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "balance_state_pkey"
DETAIL:  Key (user_id)=(99169335) already exists.
[SQL: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at]
[parameters: (-536501530, 99169335, 0, 0)]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-17 13:18:09,312 [WARNING] aiogram.dispatcher: Received SIGINT signal
2025-12-17 13:18:09,314 [INFO] aiogram.dispatcher: Polling stopped for bot @BalanceTeBot id=8531768574 - 'BalanceBot'
2025-12-17 13:18:09,314 [INFO] aiogram.dispatcher: Polling stopped
2025-12-17 13:18:12,308 [INFO] root: ðŸš€ Bot starting...
2025-12-17 13:18:12,343 [INFO] aiogram.dispatcher: Start polling
2025-12-17 13:18:12,706 [INFO] aiogram.dispatcher: Run polling for bot @BalanceTeBot id=8531768574 - 'BalanceBot'
2025-12-17 13:18:15,128 [INFO] sqlalchemy.engine.Engine: select pg_catalog.version()
2025-12-17 13:18:15,128 [INFO] sqlalchemy.engine.Engine: [raw sql] ()
2025-12-17 13:18:15,132 [INFO] sqlalchemy.engine.Engine: select current_schema()
2025-12-17 13:18:15,132 [INFO] sqlalchemy.engine.Engine: [raw sql] ()
2025-12-17 13:18:15,135 [INFO] sqlalchemy.engine.Engine: show standard_conforming_strings
2025-12-17 13:18:15,135 [INFO] sqlalchemy.engine.Engine: [raw sql] ()
2025-12-17 13:18:15,137 [INFO] sqlalchemy.engine.Engine: BEGIN (implicit)
2025-12-17 13:18:15,139 [INFO] sqlalchemy.engine.Engine: SELECT balance_state.chat_id, balance_state.user_id, balance_state.balance, balance_state.checks_count, balance_state.created_at, balance_state.updated_at 
FROM balance_state 
WHERE balance_state.chat_id = $1::BIGINT AND balance_state.user_id = $2::BIGINT
2025-12-17 13:18:15,139 [INFO] sqlalchemy.engine.Engine: [generated in 0.00012s] (-536501530, 99169335)
2025-12-17 13:18:15,145 [INFO] sqlalchemy.engine.Engine: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at
2025-12-17 13:18:15,145 [INFO] sqlalchemy.engine.Engine: [generated in 0.00018s] (-536501530, 99169335, 0, 0)
2025-12-17 13:18:15,148 [INFO] sqlalchemy.engine.Engine: INSERT INTO balance_operation (chat_id, user_id, delta) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT) RETURNING balance_operation.id, balance_operation.created_at
2025-12-17 13:18:15,148 [INFO] sqlalchemy.engine.Engine: [generated in 0.00014s] (-536501530, 99169335, 234234)
2025-12-17 13:18:15,150 [INFO] sqlalchemy.engine.Engine: ROLLBACK
2025-12-17 13:18:15,151 [INFO] aiogram.event: Update id=282851722 is not handled. Duration 51 ms by bot id=8531768574
2025-12-17 13:18:15,151 [ERROR] aiogram.event: Cause exception while process update id=282851722 by bot id=8531768574
ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column "chat_id" of relation "balance_operation" does not exist
[SQL: INSERT INTO balance_operation (chat_id, user_id, delta) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT) RETURNING balance_operation.id, balance_operation.created_at]
[parameters: (-536501530, 99169335, 234234)]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 526, in _prepare_and_execute
    prepared_stmt, attributes = await adapt_connection._prepare(
                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        operation, self._invalidate_schema_cache_asof
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 773, in _prepare
    prepared_stmt = await self._connection.prepare(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        operation, name=self._prepared_statement_name_func()
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/connection.py", line 638, in prepare
    return await self._prepare(
           ^^^^^^^^^^^^^^^^^^^^
    ...<4 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/connection.py", line 657, in _prepare
    stmt = await self._get_statement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<5 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/asyncpg/connection.py", line 443, in _get_statement
    statement = await self._protocol.prepare(
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<5 lines>...
    )
    ^
  File "asyncpg/protocol/protocol.pyx", line 165, in prepare
asyncpg.exceptions.UndefinedColumnError: column "chat_id" of relation "balance_operation" does not exist

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self._prepare_and_execute(operation, parameters)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.ProgrammingError: <class 'asyncpg.exceptions.UndefinedColumnError'>: column "chat_id" of relation "balance_operation" does not exist

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 320, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 164, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<7 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/middlewares/error.py", line 27, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/middlewares/user_context.py", line 58, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/fsm/middleware.py", line 43, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/telegram.py", line 126, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/dispatcher.py", line 283, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 161, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 153, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<4 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 189, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 161, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 153, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<4 lines>...
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/router.py", line 181, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/telegram.py", line 126, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/middlewares/admin_only.py", line 23, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/aiogram/dispatcher/event/handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/bot/handlers/balance.py", line 76, in handle_amount
    await repo.apply_delta(session, state, value)
  File "/Users/timur/PycharmProjects/balance_bot/repositories/balance.py", line 60, in apply_delta
    await session.commit()
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py", line 1000, in commit
    await greenlet_spawn(self.sync_session.commit)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 2030, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 1311, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 1286, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper,
        ^^^^^^^^^^^^
    ...<3 lines>...
        insert,
        ^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/orm/persistence.py", line 1233, in _emit_insert_statements
    result = connection.execute(
        statement,
        params,
        execution_options=execution_options,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py", line 527, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 2363, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 585, in execute
    self._adapt_connection.await_(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self._prepare_and_execute(operation, parameters)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 563, in _prepare_and_execute
    self._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 513, in _handle_exception
    self._adapt_connection._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/timur/PycharmProjects/balance_bot/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 797, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column "chat_id" of relation "balance_operation" does not exist
[SQL: INSERT INTO balance_operation (chat_id, user_id, delta) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT) RETURNING balance_operation.id, balance_operation.created_at]
[parameters: (-536501530, 99169335, 234234)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-17 13:22:47,321 [WARNING] aiogram.dispatcher: Received SIGINT signal
2025-12-17 13:22:47,325 [INFO] aiogram.dispatcher: Polling stopped for bot @BalanceTeBot id=8531768574 - 'BalanceBot'
2025-12-17 13:22:47,326 [INFO] aiogram.dispatcher: Polling stopped
2025-12-17 13:24:25,251 [INFO] root: ðŸš€ Bot starting...
2025-12-17 13:24:25,293 [INFO] aiogram.dispatcher: Start polling
2025-12-17 13:24:25,731 [INFO] aiogram.dispatcher: Run polling for bot @BalanceTeBot id=8531768574 - 'BalanceBot'
2025-12-17 13:24:50,466 [INFO] sqlalchemy.engine.Engine: select pg_catalog.version()
2025-12-17 13:24:50,467 [INFO] sqlalchemy.engine.Engine: [raw sql] ()
2025-12-17 13:24:50,472 [INFO] sqlalchemy.engine.Engine: select current_schema()
2025-12-17 13:24:50,472 [INFO] sqlalchemy.engine.Engine: [raw sql] ()
2025-12-17 13:24:50,475 [INFO] sqlalchemy.engine.Engine: show standard_conforming_strings
2025-12-17 13:24:50,475 [INFO] sqlalchemy.engine.Engine: [raw sql] ()
2025-12-17 13:24:50,477 [INFO] sqlalchemy.engine.Engine: BEGIN (implicit)
2025-12-17 13:24:50,479 [INFO] sqlalchemy.engine.Engine: SELECT balance_state.chat_id, balance_state.user_id, balance_state.balance, balance_state.checks_count, balance_state.created_at, balance_state.updated_at 
FROM balance_state 
WHERE balance_state.chat_id = $1::BIGINT AND balance_state.user_id = $2::BIGINT
2025-12-17 13:24:50,479 [INFO] sqlalchemy.engine.Engine: [generated in 0.00016s] (-536501530, 99169335)
2025-12-17 13:24:50,486 [INFO] sqlalchemy.engine.Engine: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at
2025-12-17 13:24:50,486 [INFO] sqlalchemy.engine.Engine: [generated in 0.00015s] (-536501530, 99169335, 0, 0)
2025-12-17 13:24:50,488 [INFO] sqlalchemy.engine.Engine: INSERT INTO balance_operation (chat_id, user_id, delta) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT) RETURNING balance_operation.id, balance_operation.created_at
2025-12-17 13:24:50,488 [INFO] sqlalchemy.engine.Engine: [generated in 0.00010s] (-536501530, 99169335, 23423)
2025-12-17 13:24:50,491 [INFO] sqlalchemy.engine.Engine: UPDATE balance_state SET balance=$1::BIGINT, checks_count=$2::INTEGER, updated_at=now() WHERE balance_state.chat_id = $3::BIGINT AND balance_state.user_id = $4::BIGINT
2025-12-17 13:24:50,491 [INFO] sqlalchemy.engine.Engine: [generated in 0.00014s] (23423, 1, -536501530, 99169335)
2025-12-17 13:24:50,493 [INFO] sqlalchemy.engine.Engine: COMMIT
2025-12-17 13:24:50,494 [INFO] logger.logs_setting: BALANCE_UPDATE | chat_id=-536501530 | user_id=99169335 | delta=23423 | balance: 0 -> 23423 | checks: 0 -> 1
2025-12-17 13:24:50,495 [INFO] logger.logs_setting: APPLY_DELTA | chat_id=-536501530 | user_id=99169335 | delta=23423 | balance: 0 -> 23423 | checks: 0 -> 1
2025-12-17 13:24:50,904 [INFO] aiogram.event: Update id=282851723 is handled. Duration 471 ms by bot id=8531768574
2025-12-17 13:24:58,147 [INFO] sqlalchemy.engine.Engine: BEGIN (implicit)
2025-12-17 13:24:58,147 [INFO] sqlalchemy.engine.Engine: SELECT balance_state.chat_id, balance_state.user_id, balance_state.balance, balance_state.checks_count, balance_state.created_at, balance_state.updated_at 
FROM balance_state 
WHERE balance_state.chat_id = $1::BIGINT AND balance_state.user_id = $2::BIGINT
2025-12-17 13:24:58,148 [INFO] sqlalchemy.engine.Engine: [cached since 7.668s ago] (-536501530, 99169335)
2025-12-17 13:24:58,150 [INFO] sqlalchemy.engine.Engine: INSERT INTO balance_operation (chat_id, user_id, delta) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT) RETURNING balance_operation.id, balance_operation.created_at
2025-12-17 13:24:58,150 [INFO] sqlalchemy.engine.Engine: [cached since 7.662s ago] (-536501530, 99169335, 2342342342)
2025-12-17 13:24:58,153 [INFO] sqlalchemy.engine.Engine: UPDATE balance_state SET balance=$1::BIGINT, checks_count=$2::INTEGER, updated_at=now() WHERE balance_state.chat_id = $3::BIGINT AND balance_state.user_id = $4::BIGINT
2025-12-17 13:24:58,153 [INFO] sqlalchemy.engine.Engine: [cached since 7.661s ago] (2342365765, 2, -536501530, 99169335)
2025-12-17 13:24:58,154 [INFO] sqlalchemy.engine.Engine: COMMIT
2025-12-17 13:24:58,155 [INFO] logger.logs_setting: BALANCE_UPDATE | chat_id=-536501530 | user_id=99169335 | delta=2342342342 | balance: 23423 -> 2342365765 | checks: 1 -> 2
2025-12-17 13:24:58,156 [INFO] logger.logs_setting: APPLY_DELTA | chat_id=-536501530 | user_id=99169335 | delta=2342342342 | balance: 23423 -> 2342365765 | checks: 1 -> 2
2025-12-17 13:24:58,305 [INFO] aiogram.event: Update id=282851724 is handled. Duration 169 ms by bot id=8531768574
2025-12-17 13:24:59,895 [INFO] sqlalchemy.engine.Engine: BEGIN (implicit)
2025-12-17 13:24:59,895 [INFO] sqlalchemy.engine.Engine: SELECT balance_state.chat_id, balance_state.user_id, balance_state.balance, balance_state.checks_count, balance_state.created_at, balance_state.updated_at 
FROM balance_state 
WHERE balance_state.chat_id = $1::BIGINT AND balance_state.user_id = $2::BIGINT
2025-12-17 13:24:59,895 [INFO] sqlalchemy.engine.Engine: [cached since 9.416s ago] (-536501530, 99169335)
2025-12-17 13:24:59,898 [INFO] sqlalchemy.engine.Engine: INSERT INTO balance_operation (chat_id, user_id, delta) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT) RETURNING balance_operation.id, balance_operation.created_at
2025-12-17 13:24:59,898 [INFO] sqlalchemy.engine.Engine: [cached since 9.41s ago] (-536501530, 99169335, -234234234)
2025-12-17 13:24:59,901 [INFO] sqlalchemy.engine.Engine: UPDATE balance_state SET balance=$1::BIGINT, checks_count=$2::INTEGER, updated_at=now() WHERE balance_state.chat_id = $3::BIGINT AND balance_state.user_id = $4::BIGINT
2025-12-17 13:24:59,902 [INFO] sqlalchemy.engine.Engine: [cached since 9.41s ago] (2108131531, 1, -536501530, 99169335)
2025-12-17 13:24:59,903 [INFO] sqlalchemy.engine.Engine: COMMIT
2025-12-17 13:24:59,905 [INFO] logger.logs_setting: BALANCE_UPDATE | chat_id=-536501530 | user_id=99169335 | delta=-234234234 | balance: 2342365765 -> 2108131531 | checks: 2 -> 1
2025-12-17 13:24:59,905 [INFO] logger.logs_setting: APPLY_DELTA | chat_id=-536501530 | user_id=99169335 | delta=-234234234 | balance: 2342365765 -> 2108131531 | checks: 2 -> 1
2025-12-17 13:25:00,046 [INFO] aiogram.event: Update id=282851725 is handled. Duration 156 ms by bot id=8531768574
2025-12-17 13:25:34,257 [INFO] sqlalchemy.engine.Engine: BEGIN (implicit)
2025-12-17 13:25:34,258 [INFO] sqlalchemy.engine.Engine: SELECT balance_state.chat_id, balance_state.user_id, balance_state.balance, balance_state.checks_count, balance_state.created_at, balance_state.updated_at 
FROM balance_state 
WHERE balance_state.chat_id = $1::BIGINT AND balance_state.user_id = $2::BIGINT
2025-12-17 13:25:34,258 [INFO] sqlalchemy.engine.Engine: [cached since 43.78s ago] (99169335, 99169335)
2025-12-17 13:25:34,261 [INFO] sqlalchemy.engine.Engine: INSERT INTO balance_state (chat_id, user_id, balance, checks_count) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT, $4::INTEGER) RETURNING balance_state.created_at, balance_state.updated_at
2025-12-17 13:25:34,261 [INFO] sqlalchemy.engine.Engine: [cached since 43.77s ago] (99169335, 99169335, 0, 0)
2025-12-17 13:25:34,263 [INFO] sqlalchemy.engine.Engine: INSERT INTO balance_operation (chat_id, user_id, delta) VALUES ($1::BIGINT, $2::BIGINT, $3::BIGINT) RETURNING balance_operation.id, balance_operation.created_at
2025-12-17 13:25:34,263 [INFO] sqlalchemy.engine.Engine: [cached since 43.77s ago] (99169335, 99169335, 23232)
2025-12-17 13:25:34,264 [INFO] sqlalchemy.engine.Engine: UPDATE balance_state SET balance=$1::BIGINT, checks_count=$2::INTEGER, updated_at=now() WHERE balance_state.chat_id = $3::BIGINT AND balance_state.user_id = $4::BIGINT
2025-12-17 13:25:34,264 [INFO] sqlalchemy.engine.Engine: [cached since 43.77s ago] (23232, 1, 99169335, 99169335)
2025-12-17 13:25:34,267 [INFO] sqlalchemy.engine.Engine: COMMIT
2025-12-17 13:25:34,268 [INFO] logger.logs_setting: BALANCE_UPDATE | chat_id=99169335 | user_id=99169335 | delta=23232 | balance: 0 -> 23232 | checks: 0 -> 1
2025-12-17 13:25:34,268 [INFO] logger.logs_setting: APPLY_DELTA | chat_id=99169335 | user_id=99169335 | delta=23232 | balance: 0 -> 23232 | checks: 0 -> 1
2025-12-17 13:25:34,465 [INFO] aiogram.event: Update id=282851726 is handled. Duration 215 ms by bot id=8531768574
